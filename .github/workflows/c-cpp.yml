name: C/C++ CI windows

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1

      - name: Find solution
        id: find
        shell: bash
        run: |
          SOL=$(ls *.slnx 2>/dev/null || ls *.sln 2>/dev/null || true)
          if [ -z "$SOL" ]; then
            echo "solution="
            exit 0
          fi
          SOL=$(echo "$SOL" | head -n1)
          echo "solution=$SOL" >> $GITHUB_OUTPUT

      - name: Build solution
        if: steps.find.outputs.solution != ''
        shell: bash
        run: |
          echo "Building $SOLUTION"
          SOLUTION=${{ steps.find.outputs.solution }}
          msbuild "$SOLUTION" /m /p:Configuration=Release

      - name: Fail if no solution found
        if: steps.find.outputs.solution == ''
        run: |
          echo "No .slnx or .sln found in repo." >&2
          exit 1
        shell: bash

      - name: Run tests
        shell: bash
        run: |
          # Run test executables if present (adjust glob if needed)
          set -e
          if ls *Tests.exe 1> /dev/null 2>&1; then
            for t in *Tests.exe; do echo "Running $t"; ./"$t"; done
          elif ls build/*Tests.exe 1> /dev/null 2>&1; then
            for t in build/*Tests.exe; do echo "Running $t"; ./"$t"; done
          else
            echo "No test executables found; skipping tests."
          fi

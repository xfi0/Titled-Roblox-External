name: C/C++ CI windows

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1

      - name: Find solution
        id: find
        shell: powershell
        run: |
          $sln = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Include *.slnx,*.sln -File -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($null -eq $sln) { Write-Output "solution="; exit 0 }
          Write-Output ("solution=" + $sln.Name) | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8

      - name: Build solution (MSBuild, x64, C++20)
        if: steps.find.outputs.solution != ''
        shell: powershell
        run: |
          $sln = "${{ steps.find.outputs.solution }}"
          Write-Host "Building $sln for x64 (Release) with C++20"
          # Set MSBuild properties: Configuration=Release, Platform=x64, enable C++20 (/std:c++20), Optimize etc.
          & msbuild $sln /m /p:Configuration=Release /p:Platform=x64 /p:CLToolsetVersion=Native /p:AdditionalOptions="/std:c++20"

      - name: Fail if no solution found
        if: steps.find.outputs.solution == ''
        shell: powershell
        run: |
          Write-Error "No .slnx or .sln found in repo."
          exit 1

      - name: Run tests (PowerShell)
        shell: powershell
        run: |
          $exes = Get-ChildItem -Path . -Recurse -Include *Tests.exe -File -ErrorAction SilentlyContinue
          if ($exes.Count -eq 0) {
            Write-Host "No test executables found; skipping tests."
            exit 0
          }
          foreach ($e in $exes) {
            Write-Host "Running $($e.FullName)"
            & $e.FullName
            if ($LASTEXITCODE -ne 0) { throw "Test executable $($e.Name) failed with code $LASTEXITCODE" }
          }
